<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet.groupedlayercontrol.min.css">
    <link rel="stylesheet" href="css/leaflet-control-credits.css" />
    <link rel="stylesheet" href="css/Leaflet.GraphicScale.min.css"/>
    <link rel="stylesheet" href="css/leaflet.modal.min.css"/>
    <link rel="stylesheet" href="css/custom.css">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141833019-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-141833019-2');
    </script>
    <title>Breathing Spaces - Web map</title>
</head>

<body>
    <div id="map">
    </div>
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/leaflet-svg-shape-markers.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.groupedlayercontrol.min.js"></script>

    <script src="js/leaflet-control-credits.js"></script>
    <script src="js/choropleth.js"></script>
    <script src="js/TileLayer.Grayscale.js"></script>
    <script src="js/Leaflet.GraphicScale.min.js"></script>
    <script src="js/Leaflet.Modal.min.js"></script>

    <script src="data/ActiveSensors_1.js"></script>
    <script src="data/AURN_Soton_Feb19Stats_2.js"></script>
    <script src="data/DiffusionTubeMeasurements_MergedAndFixed_2.js"></script>
    <script src="data/Perceptions.js"></script>
    <script src="data/PCM_2017.js"></script>
    <script src="data/PCM_2016.js"></script>
    <script>
        var map = L.map('map', {
            zoomControl: true,
            maxZoom: 28,
            minZoom: 1
        }).fitBounds([
            [50.91680906587142, -1.4009899783471849],
            [50.928980620670686, -1.3647479492724635]
        ]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix(
            '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot;\
             <a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; \
             &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &middot;\
             Sensor data from <a href="https://breathingspaces.org.uk/">Breathing Spaces</a>, \
             <a href="https://uk-air.defra.gov.uk/networks/network-info?view=aurn">Defra AURN</a>, \
             <a href="https://uk-air.defra.gov.uk/data/pcm-data">Defra PCM</a>,\
             <a href="https://www.southampton.gov.uk/environmental-issues/pollution/air-quality/monitoring/nitrogen-dioxide-diffusion-tubes.aspx">SCC</a>'
        );
        var bounds_group = new L.featureGroup([]);

        function setBounds() {}

        ///////////////////////////////////////////////////////////////////////////////////
        // Background map
        ///////////////////////////////////////////////////////////////////////////////////
        var layer_OSM = L.tileLayer(' https://a.tile.openstreetmap.org/{z}/{x}/{y}.png ', {
            opacity: 0.4
        });
        layer_OSM.addTo(map);

        ///////////////////////////////////////////////////////////////////////////////////
        // Active (Breathing Spaces) sensors layer
        ///////////////////////////////////////////////////////////////////////////////////
        function pop_ActiveSensors_1(feature, layer) {
            var popupContent = '<iframe src="' + feature.properties['graph_url'] + '" width="450" height="200" frameborder="0"></iframe>' +
                '<br><a href="https://opennms.computenodes.net/grafana/d/G2NTzy6mk/st-denys-detailed-measurements?orgId=1&var-node=mqtt%3A' + feature.properties['sensor_id'] + '">More details</a>' +
                '<br><b>Disclaimer:</b> The data presented has not been recorded using legally validated reference equipment and should therefore be treated with caution.'
            layer.bindPopup(popupContent, {maxWidth:430});
        }

        function style_ActiveSensors_1_0() {
            return {
                pane: 'pane_ActiveSensors_1',
                rotationAngle: 0.0,
                rotationOrigin: 'center center',
                icon: L.icon({
                    iconUrl: 'markers/sensor_icon_darkblue.svg',
                    iconSize: [26.599999999999998, 26.599999999999998]
                }),
            }
        }
        map.createPane('pane_ActiveSensors_1');
        map.getPane('pane_ActiveSensors_1').style.zIndex = 401;
        map.getPane('pane_ActiveSensors_1').style['mix-blend-mode'] = 'normal';
        var layer_ActiveSensors_1 = new L.geoJson(json_ActiveSensors_1, {
            attribution: '',
            pane: 'pane_ActiveSensors_1',
            onEachFeature: pop_ActiveSensors_1,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.marker(latlng, style_ActiveSensors_1_0(feature));
            },
        });
        bounds_group.addLayer(layer_ActiveSensors_1);
        map.addLayer(layer_ActiveSensors_1);



        ///////////////////////////////////////////////////////////////////////////////////
        // AURN layer
        ///////////////////////////////////////////////////////////////////////////////////
        function pop_AURN_Soton_Feb19Stats_2(feature, layer) {
            var popupContent = '<h3>AURN Site ' + feature.properties['site_name'] + '</h3>' +
                '<a href="graphs/' + feature.properties['site_id'] + '.html">\
                        <img src="graphs/' + feature.properties['site_id'] + '.png" width=300px></a>' +
                '(click graph to get interactive version)<br/><br/>\
                     <b>Feb 2019 PM<sub>10</sub> statistics:</b>' +
                '<table>\
                    <tr>\
                        <td><b>Mean:</b> </td> <td colspan="2">' + (feature.properties['mean'] !== null ? Autolinker
                    .link(String(feature.properties['mean'])) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td><b>Max:</b> </td> <td colspan="2">' + (feature.properties['max'] !== null ? Autolinker
                    .link(String(feature.properties['max'])) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td><b>Min:</b> </td> <td colspan="2">' + (feature.properties['min'] !== null ? Autolinker
                    .link(String(feature.properties['min'])) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td><b>Median:</b> </td> <td colspan="2">' + (feature.properties['50%'] !== null ? Autolinker
                    .link(String(feature.properties['50%'])) : '') + '</td>\
                    </tr>\
                    </table>';
            layer.bindPopup(popupContent, {
                maxHeight: 400
            });
        }

        function style_AURN_Soton_Feb19Stats_2_0(feature) {
            return {
                pane: 'pane_AURN_Soton_Feb19Stats_2',
                radius: 10.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(150,1,84,1.0)',
            }
        }
        map.createPane('pane_AURN_Soton_Feb19Stats_2');
        map.getPane('pane_AURN_Soton_Feb19Stats_2').style.zIndex = 402;
        map.getPane('pane_AURN_Soton_Feb19Stats_2').style['mix-blend-mode'] = 'normal';
        var layer_AURN_Soton_Feb19Stats_2 = new L.geoJson(json_AURN_Soton_Feb19Stats_2, {
            attribution: '',
            pane: 'pane_AURN_Soton_Feb19Stats_2',
            onEachFeature: pop_AURN_Soton_Feb19Stats_2,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_AURN_Soton_Feb19Stats_2_0(feature));
            },
        });
        bounds_group.addLayer(layer_AURN_Soton_Feb19Stats_2);
        map.addLayer(layer_AURN_Soton_Feb19Stats_2);



        ///////////////////////////////////////////////////////////////////////////////////
        // Diffusion Tubes layer
        ///////////////////////////////////////////////////////////////////////////////////
        function pop_DiffusionTubeMeasurements_MergedAndFixed_2(feature, layer) {
            var popupContent = '<h3>Diffusion tube at ' + feature.properties["Name"] + '</h3>' +
                '<b>2017 average:</b> ' + parseFloat(feature.properties['local adjusted']).toFixed(0) + '&micro;g/m<sup>3</sup>'
            layer.bindPopup(popupContent, {
                maxHeight: 400
            });
        }

        function style_DiffusionTubeMeasurements_MergedAndFixed_2_0(feature) {
            if (feature.properties['local adjusted'] >= 0.000000 && feature.properties['local adjusted'] <= 40.000000) {
                return {
                    pane: 'pane_DiffusionTubeMeasurements_MergedAndFixed_2',
                    shape: 'square',
                    radius: 6.0,
                    opacity: 1,
                    color: 'rgba(126,126,126,1.0)',
                    dashArray: '',
                    lineCap: 'butt',
                    lineJoin: 'miter',
                    weight: 1,
                    fill: true,
                    fillOpacity: 1,
                    fillColor: 'rgba(27,169,239,1.0)',
                }
            }
            if (feature.properties['local adjusted'] >= 40.000000 && feature.properties['local adjusted'] <=
                55.422097) {
                return {
                    pane: 'pane_DiffusionTubeMeasurements_MergedAndFixed_2',
                    shape: 'square',
                    radius: 6.0,
                    opacity: 1,
                    color: 'rgba(126,126,126,1.0)',
                    dashArray: '',
                    lineCap: 'butt',
                    lineJoin: 'miter',
                    weight: 1,
                    fill: true,
                    fillOpacity: 1,
                    fillColor: 'rgba(255,0,0,1.0)',
                }
            }
        }
        map.createPane('pane_DiffusionTubeMeasurements_MergedAndFixed_2');
        map.getPane('pane_DiffusionTubeMeasurements_MergedAndFixed_2').style.zIndex = 402;
        map.getPane('pane_DiffusionTubeMeasurements_MergedAndFixed_2').style['mix-blend-mode'] = 'normal';
        var layer_DiffusionTubeMeasurements_MergedAndFixed_2 = new L.geoJson(
            json_DiffusionTubeMeasurements_MergedAndFixed_2, {
                attribution: '',
                pane: 'pane_DiffusionTubeMeasurements_MergedAndFixed_2',
                onEachFeature: pop_DiffusionTubeMeasurements_MergedAndFixed_2,
                pointToLayer: function (feature, latlng) {
                    var context = {
                        feature: feature,
                        variables: {}
                    };
                    return L.shapeMarker(latlng, style_DiffusionTubeMeasurements_MergedAndFixed_2_0(feature));
                },
            });
        bounds_group.addLayer(layer_DiffusionTubeMeasurements_MergedAndFixed_2);

        layer_DiffusionTubeMeasurements_MergedAndFixed_2.on('add', function () {
            gtag('event', 'select_content', { content_type : 'Diffusion Tubes' });
            $('#legend_DiffusionTubeMeasurements').show()
        });

        layer_DiffusionTubeMeasurements_MergedAndFixed_2.on('remove', function () {
            $('#legend_DiffusionTubeMeasurements').hide()
        });
        ///////////////////////////////////////////////////////////////////////////////////
        // Perceptions layer
        ///////////////////////////////////////////////////////////////////////////////////

        var json_Perceptions_AirQuality = json_AllPerceptions.features.filter(function (entry) {
            return entry.properties.data.Type === 'Air quality concerns';
        });

        var json_Perceptions_Health = json_AllPerceptions.features.filter(function (entry) {
            return entry.properties.data.Type === 'Health concerns';
        });

        var json_Perceptions_Assets = json_AllPerceptions.features.filter(function (entry) {
            return entry.properties.data.Type === 'Neighbourhood assets';
        });

        var json_Perceptions_Change = json_AllPerceptions.features.filter(function (entry) {
            return entry.properties.data.Type === 'Ideas for change';
        });

        function pop_Perceptions(feature, layer) {
            var popupContent = '<h3>' + feature.properties["name"] + '</h3>' + feature.properties['data']['Comment'].split('\n').join('<br/>');
            layer.bindPopup(popupContent, {
                maxHeight: 400
            });
        }

        function speech_bubble_with_color(color) {
            return '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 842.777 690.811" height="26.59" width="26.59" version="1"><path d="M384.252.911c-194.4 11.1-351.2 106-380 230-10.9 46.7-.6 98.9 28.1 142.4 14.2 21.6 36.9 46.2 59 64 70.9 56.9 175.4 93.4 288.5 100.5 21 1.4 63.2 1.4 81.7.1l14.3-1.1 153.6 77.2c84.4 42.4 153.6 76.9 153.8 76.8.1-.2-28.2-44.5-63-98.4-34.9-53.9-63.4-98.2-63.4-98.5 0-.3 7.9-4.3 17.4-8.9 61.9-29.7 112.3-72.1 139.9-117.6 29.1-48 36.1-99.5 20.6-150-31.8-103.2-155.3-185.5-314.8-210-42.9-6.5-92.6-8.9-135.7-6.5z" fill="' +
                        color + '" stroke="black" stroke-width="10"/></svg>'
        }

        PERCEPTIONS_AQ_COLOR = '#1f78b4'
        PERCEPTIONS_HEALTH_COLOR = '#735290'
        PERCEPTIONS_ASSETS_COLOR = '#b2df8a'
        PERCEPTIONS_CHANGE_COLOR = '#CDDDDD'

        function style_Perceptions(feature, color) {
            return {
                rotationAngle: 0.0,
                rotationOrigin: 'center center',
                icon: L.divIcon({
                    className: 'speechbubble_icon',
                    html: speech_bubble_with_color(color),
                    iconSize: [26.599999999999998, 26.599999999999998],
                    iconAnchor: [26, 20]
                }),
            }
        }
        var layer_Perceptions_AQ = new L.geoJson(
            json_Perceptions_AirQuality, {
                attribution: '',
                onEachFeature: pop_Perceptions,
                pointToLayer: function (feature, latlng) {
                    var context = {
                        feature: feature,
                        variables: {}
                    };
                    return L.marker(latlng,
                        style_Perceptions(feature, PERCEPTIONS_AQ_COLOR));
                },
            });
        layer_Perceptions_AQ.on('add', function () {
            gtag('event', 'select_content', { content_type : 'Perceptions AQ' });
        });
        bounds_group.addLayer(layer_Perceptions_AQ);

        var layer_Perceptions_Health = new L.geoJson(
            json_Perceptions_Health, {
                attribution: '',
                onEachFeature: pop_Perceptions,
                pointToLayer: function (feature, latlng) {
                    var context = {
                        feature: feature,
                        variables: {}
                    };
                    return L.marker(latlng,
                        style_Perceptions(feature, PERCEPTIONS_HEALTH_COLOR));
                },
            });
        layer_Perceptions_Health.on('add', function () {
            gtag('event', 'select_content', { content_type : 'Perceptions Health' });
        });
        bounds_group.addLayer(layer_Perceptions_Health);

        var layer_Perceptions_Assets = new L.geoJson(
            json_Perceptions_Assets, {
                attribution: '',
                onEachFeature: pop_Perceptions,
                pointToLayer: function (feature, latlng) {
                    var context = {
                        feature: feature,
                        variables: {}
                    };
                    return L.marker(latlng,
                        style_Perceptions(feature, PERCEPTIONS_ASSETS_COLOR));
                },
            });
        layer_Perceptions_Assets.on('add', function () {
            gtag('event', 'select_content', { content_type : 'Perceptions Assets' });
        });
        bounds_group.addLayer(layer_Perceptions_Assets);

        var layer_Perceptions_Change = new L.geoJson(
            json_Perceptions_Change, {
                attribution: '',
                onEachFeature: pop_Perceptions,
                pointToLayer: function (feature, latlng) {
                    var context = {
                        feature: feature,
                        variables: {}
                    };
                    return L.marker(latlng,
                        style_Perceptions(feature, PERCEPTIONS_CHANGE_COLOR));
                },
            });
        layer_Perceptions_Change.on('add', function () {
            gtag('event', 'select_content', { content_type : 'Perceptions Change' });
        });
        bounds_group.addLayer(layer_Perceptions_Change);

        ///////////////////////////////////////////////////////////////////////////////////
        // PCM layers
        ///////////////////////////////////////////////////////////////////////////////////
    function pop_PCM_2017(feature, layer) {
            var popupContent = '<table>\
        <tr>\
            <td><b>NOx</b></td>\
            <td><b>' + parseFloat(feature.properties['nox2017']).toFixed(1) + '&micro;g/m<sup>3</sup></b></td>\
        </tr>\
        <tr>\
            <td><b>NO2</b></td>\
            <td>' + parseFloat(feature.properties['no22017']).toFixed(1) + '&micro;g/m<sup>3</sup></td>\
        </tr>\
        <tr>\
            <td><b>PM2.5</b></td>\
            <td>' + parseFloat(feature.properties['pm252017g']).toFixed(1) + '&micro;g/m<sup>3</sup></td>\
        </tr>\
        <tr>\
            <td><b>PM10</b></td>\
            <td>' + parseFloat(feature.properties['pm102017g']).toFixed(1) + '&micro;g/m<sup>3</sup></td>\
        </tr>\
    </table>';
            layer.bindPopup(popupContent, { maxHeight: 400 });
        }

    function pop_PCM_2016(feature, layer) {
            var popupContent = '<table>\
        <tr>\
            <td><b>NOx</b></td>\
            <td><b>' + parseFloat(feature.properties['nox2016']).toFixed(1) + '&micro;g/m<sup>3</sup></b></td>\
        </tr>\
        <tr>\
            <td><b>NO2</b></td>\
            <td>' + parseFloat(feature.properties['no22016']).toFixed(1) + '&micro;g/m<sup>3</sup></td>\
        </tr>\
        <tr>\
            <td><b>PM2.5</b></td>\
            <td>' + parseFloat(feature.properties['pm252016g']).toFixed(1) + '&micro;g/m<sup>3</sup></td>\
        </tr>\
        <tr>\
            <td><b>PM10</b></td>\
            <td>' + parseFloat(feature.properties['pm102016g']).toFixed(1) + '&micro;g/m<sup>3</sup></td>\
        </tr>\
    </table>';
            layer.bindPopup(popupContent, { maxHeight: 400 });
        }
        const PCM_CHOROPLETH_LIMITS = [30, 40, 50, 60, 80, 100];

        var layer_PCM_2017 = L.choropleth(json_PCM_2017, {
                valueProperty: 'nox2017',
                scale: 'YlOrRd',
                limits: PCM_CHOROPLETH_LIMITS,
                style: {
                    color: '#111111', // border color
                    weight: 1,
                    fillOpacity: 0.5,
                    fillColor: '#ffffff'
                },
                onEachFeature: pop_PCM_2017
            });

        layer_PCM_2017.on('add', function () {
            // Need setTimeout so that we don't get multiple
            // onadd/onremove events raised
            setTimeout(function() {
                map.removeLayer(layer_PCM_2016);
                gtag('event', 'select_content', { content_type : 'PCM 2017' });
                $('#legend_PCM_2017').show()
            });
        });

        layer_PCM_2017.on('remove', function () {
            $('#legend_PCM_2017').hide()
        });

        var layer_PCM_2016 = L.choropleth(json_PCM_2016, {
                valueProperty: 'nox2016',
                scale: 'YlOrRd',
                limits: PCM_CHOROPLETH_LIMITS,
                style: {
                    color: '#111111', // border color
                    weight: 1,
                    fillOpacity: 0.5,
                    fillColor: '#ffffff'
                },
                onEachFeature: pop_PCM_2016
            })

        layer_PCM_2016.on('add', function() {
            // Need setTimeout so that we don't get multiple
            // onadd/onremove events raised
            setTimeout(function() {
                map.removeLayer(layer_PCM_2017);
                gtag('event', 'select_content', { content_type : 'PCM 2016' });
                $('#legend_PCM_2016').show()
            });
        });

        layer_PCM_2016.on('remove', function () {
            $('#legend_PCM_2016').hide()
        });

        function legend_for_choropleth_layer(layer, name, units, id, info_content) {
            var limits = layer.options.limits
            var colors = layer.options.colors
            var labels = []

            HTML = name + ' <a class="infolink" href="#" onclick="showInfoDialog(' + info_content + ')"><img class="infobutton" src="images/questionbutton.svg"></a>'

            limits.forEach(function (limit, index) {
                if (index === 0) {
                    var to = parseFloat(limits[index]).toFixed(1);
                    var range_str = "< " + to;
                }
                else {
                    var from = parseFloat(limits[index - 1]).toFixed(1);
                    var to = parseFloat(limits[index]).toFixed(1);
                    var range_str = from + "-" + to;
                }
                
                labels.push('<li class="sublegend-item"><div class="sublegend-color" style="background-color: ' + colors[index] + '">&nbsp;</div>&nbsp;' + range_str + units + '</li>')
            })

            HTML += '<ul id="' + id + '" class="sublegend" style="display: none">' + labels.join('') + '</ul>'

            return HTML;
        }

        INFO_BREATHING_SPACES = "<h2>Breathing Spaces sensors</h2>\
        <p>The Breathing Spaces sensors are a set of low-cost air quality sensors, deployed as part of the\
        <a href='https://breathingspaces.org.uk/'>Breathing Spaces</a> project in Southampton. The sensors\
        have been developed by a team at the University of Southampton, and measure particulate matter\
        pollution, which consists of tiny particles that can get deep inside your lungs and cause health\
        effects such as cardiovascular disease.</p>\
        <p>Particulate matter is split into two components: PM<sub>10</sub> and PM<sub>2.5</sub>, which consist\
        of particles smaller than 2.5&micro;m and 10&micro;m respectively (for\
        comparison, the width of a human hair is around 75&micro;m). The measurements are provided in\
        &micro;g/m<sup>3</sup>, the weight of particles per cubic metre of air.</p>\</p>\
        <p>An academic paper describing and evaluating the PM sensors used is available <a\
        href='https://www.nature.com/articles/s41598-019-43716-3'>here</a>."

        INFO_AURN = "<h2>AURN PM<sub>2.5</sub></h2>\
        <p>The <a href='https://uk-air.defra.gov.uk/networks/network-info?view=aurn'>Automatic Urban-Rural Network (AURN)</a>\
        is a network of air pollution monitoring stations\
        run by the Department for Environment, Food and Rural Affairs (Defra). Each automated site\
        monitors a range of pollutants; here we are focusing on PM<sub>2.5</sub>, the smallest type\
        of particulate matter (which consists of tiny particles floating in the air).</p>\
        <p>The measurements are provided in &micro;g/m<sup>3</sup>, the weight of particles per cubic\
        metre of air.</p>\
        <p>The AURN network is used for government air quality assessments, and is therefore calibrated\
        to reference standards, and produces highly accurate and reliable measurements.\
        <p>Detailed graphs are available <a href='http://southampton.my-air.uk/graphs/'>here</a>."

        INFO_DIFFUSION_TUBES = "<h2>SCC Diffusion Tubes (NO<sub>2</sub>) (2017)</h2>\
        <p>Southampton City Council (SCC) operate a set of diffusion tubes to measure NO<sub>2</sub> \
        (Nitrogen Dioxide) pollution across Southampton. These are passive air quality measurement devices\
        which are left in-situ for around a month to absorb NO<sub>2</sub> from the air, and then analysed in\
        a laboratory to assess how much NO<sub>2</sub> was absorbed over that period</p>\
        <p>Southampton City Council provides one measurement per month for each site, along with an annual\
        average. We are displaying this annual average on the map, coloured according to whether it is over the\
        40&micro;g/m<sup>3</sup> limit.</p>\
        <p>The measurements displayed are from 2017 as more recent data has not yet been released by Southampton\
        City Council.</p>\
        <p>Raw data and summary reports are available on the <a\
                href='https://www.southampton.gov.uk/environmental-issues/pollution/air-quality/monitoring/nitrogen-dioxide-diffusion-tubes.aspx'>Southampton City Council website</a>.</p>"

        INFO_PCM_GENERIC = "<p>The Department for Environment, Food and Rural Affairs (Defra) uses models to predict\
        background air pollution levels for each 1km x 1km square of land across the UK. The predicted levels of\
        Nitrous Oxides (NOx) are shown here in &micro;g/m<sup>3</sup>, by clicking on a grid square you can also see\
        the predicted levels of other pollutants.</p>\
        <p>The models take into account a range of potential sources of air pollution including large and small sources\
        from the UK National Atmospheric Emissions Inventory, distant sources (such as pollution from the continent),\
        industrial sources, road traffic and other miscellaneous sources.</p>\
        Further details are available on the <a href='https://uk-air.defra.gov.uk/data/pcm-data'>Defra website</a>."
        
        INFO_PCM_2016 = "<h2>Defra PCM (NOx) (2016)</h2>" + INFO_PCM_GENERIC

        INFO_PCM_2017 = "<h2>Defra PCM (NOx) (2017)</h2>" + INFO_PCM_GENERIC + "<p>\
        <b>Note:</b> The predicted NOx levels for 2017 are significantly lower than those predicted for 2016.\
        This has not yet been fully explained by Defra, so data from both years are provided for comparison.</p>"

        INFO_COMMUNITY_PERCEPTIONS = "<h2>Community perceptions</h2>\
        <p>At various Breathing Spaces community meetings, participants were invited to make notes on a map of\
        the area, expressing their concerns about air quality and health, as well as their ideas for change, and\
        community assets. These have been transcribed and are available here; click on a marker to read the comment.</p>"

        function showInfoDialog(content) {
            map.openModal({content: content})
        }

        ///////////////////////////////////////////////////////////////////////////////////
        // Legend
        ///////////////////////////////////////////////////////////////////////////////////
        var baseMaps = {};
        var groupedOverlays = {
            'Current data': {
                '<img src="legend/sensor_icon_darkblue.png" height=20px /> Breathing Spaces sensors\
                <a class="infolink" href="#" onclick="showInfoDialog(INFO_BREATHING_SPACES)"><img class="infobutton" src="images/questionbutton.svg"></a>': layer_ActiveSensors_1,
                '<img class="legendicon" src="images/circle.svg"/> AURN PM<sub>2.5</sub>\
                <a class="infolink" href="#" onclick="showInfoDialog(INFO_AURN)"><img class="infobutton" src="images/questionbutton.svg"></a>': layer_AURN_Soton_Feb19Stats_2
            },
            'Historical data': {
            'SCC Diffusion Tubes (NO<sub>2</sub>) (2017) <a class="infolink" href="#" onclick="showInfoDialog(INFO_DIFFUSION_TUBES)"><img class="infobutton" src="images/questionbutton.svg"></a><br />\
            <table id="legend_DiffusionTubeMeasurements" style="display: none">\
                <tr>\
                    <td class="legend-subitem" style="text-align: center; vertical-align: bottom;">\
                        <img\
                            src="legend/DiffusionTubeMeasurements_MergedAndFixed_2_1953740.png" /></td>\
                    <td> Below legal limit (&lt; 40&micro;g/m<sup>3</sup>) </td>\
                </tr>\
                <tr>\
                    <td class="legend-subitem" style="text-align: center;"><img\
                            src="legend/DiffusionTubeMeasurements_MergedAndFixed_2_3745541.png" /></td>\
                    <td> Above legal limit (&gt; 40&micro;g/m<sup>3</sup>) </td>\
                </tr>\
            </table>': layer_DiffusionTubeMeasurements_MergedAndFixed_2,
            [legend_for_choropleth_layer(layer_PCM_2016, 'Defra PCM (NOx) (2016)', '&micro;g/m<sup>3</sup>', 'legend_PCM_2016', 'INFO_PCM_2016')]: layer_PCM_2016,
            [legend_for_choropleth_layer(layer_PCM_2017, 'Defra PCM (NOx) (2017)', '&micro;g/m<sup>3</sup>', 'legend_PCM_2017', 'INFO_PCM_2017')]: layer_PCM_2017

            },
            'Community perceptions <a class="infolink" href="#" onclick="showInfoDialog(INFO_COMMUNITY_PERCEPTIONS)"><img class="infobutton" src="images/questionbutton.svg"></a>': {
            [speech_bubble_with_color(PERCEPTIONS_AQ_COLOR) + '&nbsp; Air Quality concerns']: layer_Perceptions_AQ,
            [speech_bubble_with_color(PERCEPTIONS_HEALTH_COLOR) + '&nbsp; Health concerns']: layer_Perceptions_Health,
            [speech_bubble_with_color(PERCEPTIONS_ASSETS_COLOR) + '&nbsp; Community assets']: layer_Perceptions_Assets,
            [speech_bubble_with_color(PERCEPTIONS_CHANGE_COLOR) + '&nbsp; Ideas for change']: layer_Perceptions_Change,
            }
        };

        if (L.Browser.mobile) {
            layersControlCollapsed = true;
        } else {
            layersControlCollapsed = false;
        }

        var layersControl = L.control.groupedLayers(baseMaps, groupedOverlays, {
            collapsed: layersControlCollapsed
        });
        layersControl.addTo(map);

        scaleOpts = {position: 'bottomright',
                     fill: 'fill'
                    }

        if (L.Browser.mobile) {
            scaleOpts['maxUnitsWidth'] = 100;
        }

        L.control.graphicScale(scaleOpts).addTo(map);

        var credctrl = L.controlCredits({
                image: "./images/logo.jpeg",
                link: "https://breathingspaces.org.uk/",
                text: "Map created by the Breathing Spaces project, click here for more information",
                width: (L.Browser.mobile ? 75 : 150),
                height: (L.Browser.mobile ? 75 : 150),
            }).addTo(map);

        setBounds();
    </script>
</body>

</html>